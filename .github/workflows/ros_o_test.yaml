on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-22.04
    name: ros_o_build_test
    env:
      CATKIN_WS: /home/runner/work/catkin_ws
    strategy:
      fail-fast: false

    steps:
      - name: Setup OS
        run: |
          sudo apt-get update -y
          sudo apt-get upgrade -y

      - name: Setup Git
        run: |
          sudo apt-get install -y git

      - name: Install ROS-O
        run: |
          sudo apt-get install -y vim less ca-certificates sudo bash-completion python3-pip git tmux python-is-python3
          pip3 install catkin-tools
          echo "deb [trusted=yes] https://raw.githubusercontent.com/sugikazu75/ros-o-builder/jammy-one-unstable/repository ./" | sudo tee /etc/apt/sources.list.d/sugikazu75_ros-o-builder.list
          sudo apt update
          sudo apt install -y python3-rosdep2
          echo "yaml https://raw.githubusercontent.com/sugikazu75/ros-o-builder/jammy-one-unstable/repository/local.yaml debian" | sudo tee /etc/ros/rosdep/sources.list.d/1-sugikazu75_ros-o-builder.list
          rosdep update
          sudo apt-get install -y ros-one-desktop-full
          sudo apt-get install -y python3-wstool

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup ROS workspace
        run: |
          source /opt/ros/one/setup.bash
          mkdir -p ${CATKIN_WS}/src && cd ${CATKIN_WS}
          wstool init src
          cp -r ${GITHUB_WORKSPACE} ${CATKIN_WS}/src
          wstool merge -t src src/jsk_aerial_robot/aerial_robot_${ROS_DISTRO}.rosinstall
          wstool update -t src
          set +e
          rosdep install -y -r --from-paths src --ignore-src --rosdistro $ROS_DISTRO
          set -e
          catkin build aerial_robot --no-status
          catkin build --catkin-make-args run_tests -- -i --no-deps --no-status -p 1 -j 1 aerial_robot
          catkin_test_results --verbose build || catkin_test_results --all build
