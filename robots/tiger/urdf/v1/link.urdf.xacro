<?xml version="1.0"?>
<robot
    xmlns:xacro="http://www.ros.org/wiki/xacro" name="tiger_link">
  <xacro:include filename="$(find tiger)/urdf/v1/common.xacro" />

  <xacro:macro name="tiger_joint_junction_link" params="self child leg type">
    <link name="joint_junction_link${self}">
      <xacro:if value="${type == 'belt'}">
        <inertial>
          <mass value="0.095"/>
          <origin xyz="0.026 -0.004 0.004" rpy="0 0 0"/>
          <inertia
              ixx="0.000074" iyy="0.000079" izz="0.000079"
              ixy="-0.000009" iyz="0.000001" ixz="-0.000009"/>
        </inertial>
        <xacro:mesh_model type="link/joint_junction_link_belt">
          <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:mesh_model>
      </xacro:if>
      <xacro:if value="${type == 'wire_belt'}">
        <inertial>
          <mass value="0.103"/>
          <origin xyz="0.028 -0.007 -0.003" rpy="0 0 0"/>
          <inertia
              ixx="0.000087" iyy="0.000087" izz="0.000096"
              ixy="-0.000016" iyz="-0.000002" ixz="0.000010"/>
        </inertial>
        <xacro:mesh_model type="link/joint_junction_link_wire_belt">
          <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:mesh_model>
      </xacro:if>
    </link>
    <xacro:friction link="joint_junction_link${self}"/>
    <xacro:damping_factor link="joint_junction_link${self}"/>

    <joint name="joint${self}_pitch" type="revolute">
      <limit effort="${max_joint_torque}" lower="${-pi/2}" upper="${pi/2}" velocity="${max_joint_vel}"/>
      <parent link="joint_junction_link${self}"/>
      <child link="${child}"/>
      <origin rpy="0 0 0" xyz="0.0515 0.0 0.0"/>
      <axis xyz="0 1 0"/>
      <dynamics damping="0.9" friction="0.0"/>
    </joint>

    <xacro:joint_transmission joint="joint${self}_pitch"/>

    <xacro:if value="${leg == 1}">
      <xacro:extra_module_with_collision name="joint_junction_leg${self}" parent="joint_junction_link${self}" visible="1" model_url="package://tiger/urdf/v1/mesh/leg/leg.dae">
        <origin xyz="0 0 -0.0323" rpy="0 0 ${pi/2}"/>
        <inertial>
          <mass value="0.024"/>
          <origin xyz="0 0 -0.047" rpy="0 0 0"/>
          <inertia
              ixx="0.000029" iyy="0.000029" izz="0.000002"
              ixy="0.000000" iyz="0.000000" ixz="0.000000"/>
        </inertial>
        <xacro:leg_collision_model/>
      </xacro:extra_module_with_collision>
    </xacro:if>
 
  </xacro:macro>

  #### CENTER LINK ####
  <xacro:macro name="tiger_center_link" params="child1 child2 child3 child4 leg">
    #### dummy root link for KDL ####
    <link name="root">
      <inertial>
        <mass value="0.00001"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia
            ixx="0.000001" ixy="0.0" ixz="0.0"
            iyy="0.000001" iyz="0.0"
            izz="0.000001"/>
      </inertial>
    </link>
    <joint name="root_joint" type="fixed">
      <parent link="root"/>
      <child link="center_link"/>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <axis xyz="0 0 1"/>
    </joint>

    #### link ####
    <link name="center_link">
      <inertial>
        <mass value="1.1780349"/>
        <origin xyz="0.0000000 0.0001434 -0.0335345" rpy="0 0 0"/>
        <inertia
            ixx="0.0095261" iyy="0.0095185" izz="0.0171496"
            ixy="0.0000000" iyz="0.0000057" ixz="0.0000000" />
      </inertial>
      <xacro:mesh_model type="link/center_link">
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </xacro:mesh_model>
      <collision>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <geometry>
          <cylinder length="${center_link_height}" radius="${center_link_radius}"/>
        </geometry>
      </collision>
    </link>
    <xacro:friction link="center_link"/>
    <xacro:damping_factor link="center_link"/>

    <xacro:tiger_joint_junction_link self="${child1}" child="link${child1}" leg="${leg}" type="wire_belt"/>
    <xacro:tiger_joint_junction_link self="${child2}" child="link${child2}" leg="${leg}" type="wire_belt"/>
    <xacro:tiger_joint_junction_link self="${child3}" child="link${child3}" leg="${leg}" type="wire_belt"/>
    <xacro:tiger_joint_junction_link self="${child4}" child="link${child4}" leg="${leg}" type="wire_belt"/>

    #### joints ####
    <joint name="joint${child1}_yaw" type="revolute">
      <limit effort="${max_joint_torque}" lower="${-pi/2}" upper="${pi/2}" velocity="${max_joint_vel}"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child1}"/>
      <origin rpy="0 0 ${pi / 4}" xyz="0.12233 0.12233 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.9" friction="0.0"/>
    </joint>

    <joint name="joint${child2}_yaw" type="revolute">
      <limit effort="${max_joint_torque}" lower="${-pi/2}" upper="${pi/2}" velocity="${max_joint_vel}"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child2}"/>
      <origin rpy="0 0 ${pi * 3 / 4}" xyz="-0.12233 0.12233 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.9" friction="0.0"/>
    </joint>

    <joint name="joint${child3}_yaw" type="revolute">
      <limit effort="${max_joint_torque}" lower="${-pi/2}" upper="${pi/2}" velocity="${max_joint_vel}"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child3}"/>
      <origin rpy="0 0 ${pi * 5 / 4}" xyz="-0.12233 -0.12233 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.9" friction="0.0"/>
    </joint>

    <joint name="joint${child4}_yaw" type="revolute">
      <limit effort="${max_joint_torque}" lower="${-pi/2}" upper="${pi/2}" velocity="${max_joint_vel}"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child4}"/>
      <origin rpy="0 0 ${pi * 7 / 4}" xyz="0.12233 -0.12233 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.9" friction="0.0"/>
    </joint>

    #### hardware interface ####
    <xacro:joint_transmission joint="joint${child1}_yaw"/>
    <xacro:joint_transmission joint="joint${child2}_yaw"/>
    <xacro:joint_transmission joint="joint${child3}_yaw"/>
    <xacro:joint_transmission joint="joint${child4}_yaw"/>
  </xacro:macro>

  #### LINK ####
  <xacro:macro name="tiger_link" params="self child link_type battery leg">
    #### link ####
    <link name="link${self}">
      <xacro:if value="${link_type == 'general'}">
        <inertial>
          <mass value="0.523"/>
          <origin xyz="0.257 -0.002 0.017" rpy="0 0 0"/>
          <inertia
              ixx="0.000383" iyy="0.021153" izz="0.020931"
              ixy="0.000250" iyz="-0.000021" ixz="0.000494" />
        </inertial>
        <xacro:mesh_model type="link/general_link">
          <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:mesh_model>
        <xacro:link_collision_model/>
      </xacro:if>
      <xacro:if value="${link_type == 'end'}">
        <inertial>
          <mass value="0.347"/>
          <origin xyz="0.157 -0.015 0" rpy="0 0 0"/>
          <inertia
              ixx="0.000276" iyy="0.008551" izz="0.008772"
              ixy="0.000606" iyz="-0.000002" ixz="-0.000029" />
        </inertial>
        <xacro:mesh_model type="link/end_link">
          <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:mesh_model>
        <xacro:link_collision_model/>
      </xacro:if>
    </link>
    <xacro:friction link="link${self}"/>
    <xacro:damping_factor link="link${self}"/>

    #### gimbal roll ####
    <link name="gimbal${self}_roll_module">
      <inertial>
        <mass value="0.275"/>
        <origin xyz="0.0145839 -0.0007152 -0.0219046" rpy="0 0 0"/>
        <inertia
            ixx="0.000456" iyy="0.000504" izz="0.000157"
            ixy="0.000003" iyz="-0.000009" ixz="-0.000125" />
      </inertial>
      <xacro:mesh_model type="link/roll_link">
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </xacro:mesh_model>
    </link>
    <xacro:friction link="gimbal${self}_roll_module"/>
    <xacro:damping_factor link="gimbal${self}_roll_module"/>

    #### gimbal pitch ####
    <link name="gimbal${self}_pitch_module">
      <inertial>
        <mass value="0.434"/>
        <origin xyz="0.0000111 -0.0015087 -0.0010901" rpy="0 0 0"/>
        <inertia
            ixx="0.007595" iyy="0.000401" izz="0.007781"
            ixy="0.000000" iyz="0.000010" ixz="0.000000" />
      </inertial>
      <xacro:mesh_model type="link/pitch_link">
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </xacro:mesh_model>
    </link>
    <xacro:friction link="gimbal${self}_pitch_module"/>
    <xacro:damping_factor link="gimbal${self}_pitch_module"/>

    #### thrust link (virtual) ####
    <link name="thrust${self}">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.00001"/>
        <inertia
            ixx="0.000001" iyy="0.000001" izz="0.000001"
            ixy="0.0" iyz="0.0" ixz="0.0"/>
      </inertial>
    </link>
    <xacro:damping_factor link="thrust${self}"/>

    #### special part of duct fun (temporary)####
    <joint name="edf${self}_left_mount" type="fixed">
      <child link="edf${self}_left"/>
      <parent link="gimbal${self}_pitch_module"/>
      <origin rpy="0 0 0" xyz="0 0.1335 0 "/>
      <axis xyz="0 0 1"/>
    </joint>
    <link name="edf${self}_left">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.00001"/>
        <inertia
            ixx="0.000001" ixy="0.0" ixz="0.0"
            iyy="0.000001" iyz="0.0"
            izz="0.000002"/>
      </inertial>
    </link>
    <joint name="edf${self}_right_mount" type="fixed">
      <child link="edf${self}_right"/>
      <parent link="gimbal${self}_pitch_module"/>
      <origin rpy="0 0 0" xyz="0 -0.1335 0 "/>
      <axis xyz="0 0 1"/>
    </joint>
    <link name="edf${self}_right">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.00001"/>
        <inertia
            ixx="0.000001" ixy="0.0" ixz="0.0"
            iyy="0.000001" iyz="0.0"
            izz="0.000002"/>
      </inertial>
    </link>

    #### joint junction ####
    <xacro:unless value="${self == child}">
      <xacro:tiger_joint_junction_link self="${child}" child="link${child}" leg="${leg}" type="belt"/>
    </xacro:unless>

    #### joints ####
    #### link joint ####
    <xacro:unless value="${self == child}">
      <joint name="joint${child}_yaw" type="revolute">
        <limit effort="${max_joint_torque}" lower="${-pi/2}" upper="${pi}" velocity="${max_joint_vel}"/>
        <parent link="link${self}"/>
        <child link="joint_junction_link${child}"/>
        <origin rpy="0 0 0" xyz="${general_link_length} 0 0"/>
        <axis xyz="0 0 1"/>
        <dynamics damping="0.9" friction="0.0"/>
      </joint>
    </xacro:unless>

    #### gimbal joint ####
    <joint name="gimbal${self}_roll" type="continuous">
      <limit effort="1.5" lower="${pi * -6}" upper="${pi * 6}" velocity="10.0"/>
      <parent link="link${self}"/>
      <child link="gimbal${self}_roll_module"/>
      <origin rpy="0 0 0" xyz="0.268 0.0 0.0"/>
      <axis xyz="1 0 0"/>
      <dynamics damping="0.1" friction="0.0"/>
    </joint>

    <joint name="gimbal${self}_pitch" type="continuous">
      <limit effort="1.5" lower="${pi * -6}" upper="${pi * 6}" velocity="10.0"/>
      <parent link="gimbal${self}_roll_module"/>
      <child link="gimbal${self}_pitch_module"/>
      <origin rpy="0 0 0" xyz="-0.0065 0.0 -0.027"/>
      <axis xyz="0 1 0"/>
      <dynamics damping="0.1" friction="0.0"/>
    </joint>

    #### rotor joint (virtual) ####
    <joint name="rotor${self}" type="continuous">
     <limit effort="100.0" lower="0" upper="${max_force}" velocity="0.5"/>
      <parent link="gimbal${self}_pitch_module"/>
      <child link="thrust${self}"/>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <axis xyz="0 0 1"/>
    </joint>

    #### battery ####
    <xacro:if value="${battery == 1}">
      <xacro:extra_module name="bat${self}" parent="link${self}" visible="1"
                          model_url="package://tiger/urdf/v1/mesh/battery/ZIPPY-3000-25C-6S.dae">
        <origin xyz="0.410 0.0 -0.039" rpy="${-pi/2} 0 0"/>
        <inertial>
          <mass value="0.417"/>
          <origin xyz="-0.001 0.0 0.0" rpy="0 0 0"/>
          <inertia
              ixx="0.000099" iyy="0.000700" izz="0.000673"
              ixy="0.000000" iyz="0.000000" ixz="-0.000001" />
        </inertial>
      </xacro:extra_module>
    </xacro:if>

    #### end leg ####
    <xacro:if value="${leg == 1}">
      <xacro:if value="${link_type == 'end'}">
        <xacro:extra_module_with_collision name="end_leg${self}" parent="link${self}" visible="1"
                            model_url="package://tiger/urdf/v1/mesh/leg/end_leg.dae">
          <origin xyz="0.160 0.0 0.0" rpy="0 0 0"/>
          <inertial>
            <mass value="0.055"/>
            <origin xyz="0.0000000 0.0000 -0.035" rpy="0 0 0"/>
            <inertia
                ixx="0.000116" iyy="0.000114" izz="0.000012"
                ixy="0.000000" iyz="0.000000" ixz="0.000000" />
          </inertial>
          <xacro:end_leg_collision_model/>
        </xacro:extra_module_with_collision>
      </xacro:if>
    </xacro:if>


    #### hardware interface ####
    <xacro:unless value="${self == child}">
      <xacro:joint_transmission joint="joint${child}_yaw"/>
    </xacro:unless>

    <xacro:joint_transmission joint="gimbal${self}_roll"/>
    <xacro:joint_transmission joint="gimbal${self}_pitch"/>

    <transmission name="rotor_tran${self}">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="rotor${self}">
        <hardwareInterface>RotorInterface</hardwareInterface>
      </joint>
      <actuator name="rotor_actuator${self}">
        <hardwareInterface>RotorInterface</hardwareInterface>
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro>

</robot>
