<?xml version="1.0"?>
<robot
    xmlns:xacro="http://www.ros.org/wiki/xacro" name="tiger_link">
  <xacro:include filename="$(find tiger)/urdf/v1/common.xacro" />

  <xacro:macro name="tiger_joint_junction_link" params="self child leg">
    <link name="joint_junction_link${self}">
      <inertial>
        <mass value="0.0953384"/>
        <origin xyz="0.0257500 -0.0037552 0.0037552" rpy="0 0 0"/>
        <inertia
            ixx="0.0000741" iyy="0.0000792" izz="0.0000792"
            ixy="-0.0000092" iyz="0.0000013" ixz="-0.0000092"/>
      </inertial>
      <xacro:mesh_model type="link/joint_junction_link">
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </xacro:mesh_model>
    </link>
    <xacro:friction link="joint_junction_link${self}"/>
    <xacro:damping_factor link="joint_junction_link${self}"/>

    <joint name="joint${self}_pitch" type="revolute">
      <limit effort="100" lower="${-pi/2}" upper="${pi/2}" velocity="3.0"/>
      <parent link="joint_junction_link${self}"/>
      <child link="${child}"/>
      <origin rpy="0 0 0" xyz="0.0515 0.0 0.0"/>
      <axis xyz="0 1 0"/>
      <dynamics damping="0.8" friction="0.0"/>
    </joint>

    <xacro:joint_transmission joint="joint${self}_pitch"/>

    <xacro:if value="${leg == 1}">
      <xacro:extra_module name="joint_junction_leg${self}" parent="joint_junction_link${self}" visible="1" collision="1" model_url="package://tiger/urdf/v1/mesh/leg/leg.dae">
        <origin xyz="0 0 -0.0283" rpy="0 ${pi} 0"/>
        <inertial>
          <mass value="0.0230696"/>
          <origin xyz="0 0.0000465 0.0474391" rpy="0 0 0"/>
          <inertia
              ixx="0.0000295" iyy="0.0000293" izz="0.0000014"
              ixy="0.0000000" iyz="0.0000000" ixz="0.0000000"/>
        </inertial>
      </xacro:extra_module>
    </xacro:if>
  </xacro:macro>

  #### CENTER LINK ####
  <xacro:macro name="tiger_center_link" params="child1 child2 child3 child4 leg">
    #### dummy root link for KDL ####
    <link name="root">
      <inertial>
        <mass value="0.00001"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <inertia
            ixx="0.000001" ixy="0.0" ixz="0.0"
            iyy="0.000001" iyz="0.0"
            izz="0.000001"/>
      </inertial>
    </link>
    <joint name="root_joint" type="fixed">
      <parent link="root"/>
      <child link="center_link"/>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <axis xyz="0 0 1"/>
    </joint>

    #### link ####
    <link name="center_link">
      <inertial>
        <mass value="1.1716010"/>
        <origin xyz="0.0000000 0.0001441 0.0025981" rpy="0 0 0"/>
        <inertia
            ixx="0.0094720" iyy="0.0094643" izz="0.0170567"
            ixy="-0.000000" ixz="-0.000000" iyz="-0.0000004"/>
      </inertial>
      <xacro:mesh_model type="link/center_link">
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </xacro:mesh_model>
      <collision>
        <origin rpy="0 0 0" xyz="0 0 0"/>
        <geometry>
          <cylinder length="${center_link_height}" radius="${center_link_radius}"/>
        </geometry>
      </collision>
    </link>
    <xacro:friction link="center_link"/>
    <xacro:damping_factor link="center_link"/>

    <xacro:tiger_joint_junction_link self="${child1}" child="link${child1}" leg="${leg}"/>
    <xacro:tiger_joint_junction_link self="${child2}" child="link${child2}" leg="${leg}"/>
    <xacro:tiger_joint_junction_link self="${child3}" child="link${child3}" leg="${leg}"/>
    <xacro:tiger_joint_junction_link self="${child4}" child="link${child4}" leg="${leg}"/>

    #### joints ####
    <joint name="joint${child1}_yaw" type="revolute">
      <limit effort="100" lower="${-pi/2}" upper="${pi/2}" velocity="3.0"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child1}"/>
      <origin rpy="0 0 ${pi / 4}" xyz="0.1195 0.1195 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.8" friction="0.0"/>
    </joint>

    <joint name="joint${child2}_yaw" type="revolute">
      <limit effort="100" lower="${-pi/2}" upper="${pi/2}" velocity="3.0"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child2}"/>
      <origin rpy="0 0 ${pi * 3 / 4}" xyz="-0.1195 0.1195 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.8" friction="0.0"/>
    </joint>

    <joint name="joint${child3}_yaw" type="revolute">
      <limit effort="100" lower="${-pi/2}" upper="${pi/2}" velocity="3.0"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child3}"/>
      <origin rpy="0 0 ${pi * 5 / 4}" xyz="-0.1195 -0.1195 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.8" friction="0.0"/>
    </joint>

    <joint name="joint${child4}_yaw" type="revolute">
      <limit effort="100" lower="${-pi/2}" upper="${pi/2}" velocity="3.0"/>
      <parent link="center_link"/>
      <child link="joint_junction_link${child4}"/>
      <origin rpy="0 0 ${pi * 7 / 4}" xyz="0.1195 -0.1195 -0.0155"/>
      <axis xyz="0 0 1"/>
      <dynamics damping="0.8" friction="0.0"/>
    </joint>

    #### hardware interface ####
    <xacro:joint_transmission joint="joint${child1}_yaw"/>
    <xacro:joint_transmission joint="joint${child2}_yaw"/>
    <xacro:joint_transmission joint="joint${child3}_yaw"/>
    <xacro:joint_transmission joint="joint${child4}_yaw"/>
  </xacro:macro>

  #### LINK ####
  <xacro:macro name="tiger_link" params="self child link_type battery leg">
    #### link ####
    <link name="link${self}">
      <xacro:if value="${link_type == 'general'}">
        <inertial>
          <mass value="0.5104648"/>
          <origin xyz="0.2574944 -0.0101285 0.0100891" rpy="0 0 0"/>
          <inertia
              ixx="0.0005824" iyy="0.0208863" izz="0.0208885"
              ixy="0.0011182" iyz="0.0000521" ixz="0.0012028"/>
        </inertial>
        <xacro:mesh_model type="link/general_link">
          <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:mesh_model>
        <xacro:link_collision_model/>
      </xacro:if>
      <xacro:if value="${link_type == 'end'}">
        <inertial>
          <mass value="0.3371341"/>
          <origin xyz="0.1511545 -0.0153166 0.0000464" rpy="0 0 0"/>
          <inertia
              ixx="0.0002704" iyy="0.0079527" izz="0.0081722"
              ixy="0.0005706" iyz="0.0000002" ixz="0.0000009" />
        </inertial>
        <xacro:mesh_model type="link/end_link">
          <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:mesh_model>
        <xacro:link_collision_model/>
      </xacro:if>
    </link>
    <xacro:friction link="link${self}"/>
    <xacro:damping_factor link="link${self}"/>

    #### gimbal roll ####
    <link name="gimbal_roll_link${self}">
      <inertial>
        <mass value="0.2749981"/>
        <origin xyz="0.0145839 -0.0007152 -0.0219046" rpy="0 0 0"/>
        <!-- <inertia -->
        <!--     ixx="0.0004558" iyy="0.0005038" izz="0.0001566" -->
        <!--     ixy="0.0000029" iyz="-0.0000086" ixz="-0.0001245" /> -->
        <inertia
            ixx="0.004558" iyy="0.005038" izz="0.001566"
            ixy="0.0000029" iyz="-0.0000086" ixz="-0.0001245" />
      </inertial>
      <xacro:mesh_model type="link/roll_link">
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </xacro:mesh_model>
    </link>
    <xacro:friction link="gimbal_roll_link${self}"/>
    <xacro:damping_factor link="gimbal_roll_link${self}"/>

    #### gimbal pitch ####
    <link name="gimbal_pitch_link${self}">
      <inertial>
        <mass value="0.4336874"/>
        <origin xyz="0.0015167 0.0000151 -0.0010897" rpy="0 0 0"/>
        <!-- <inertia -->
        <!--     ixx="0.0004013" iyy="0.0075949" izz="0.0077808" -->
        <!--     ixy="0.0000001" iyz="-0.0000001" ixz="-0.0000103" /> -->
        <inertia
            ixx="0.004013" iyy="0.0075949" izz="0.0077808"
            ixy="0.0000001" iyz="-0.0000001" ixz="-0.0000103" />
      </inertial>
      <xacro:mesh_model type="link/pitch_link">
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </xacro:mesh_model>
    </link>
    <xacro:friction link="gimbal_pitch_link${self}"/>
    <xacro:damping_factor link="gimbal_pitch_link${self}"/>

    #### thrust link (virtual) ####
    <link name="thrust${self}">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.00001"/>
        <inertia
            ixx="0.000001" iyy="0.000001" izz="0.000001"
            ixy="0.0" iyz="0.0" ixz="0.0"/>
      </inertial>
    </link>
    <xacro:damping_factor link="thrust${self}"/>

    #### special part of duct fun ####
    <joint name="edf${self}_left_mount" type="fixed">
      <child link="edf${self}_left"/>
      <parent link="gimbal_pitch_link${self}"/>
      <origin rpy="0 0 0" xyz="0.15 0 0 "/>
      <axis xyz="0 0 1"/>
    </joint>
    <link name="edf${self}_left">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.00001"/>
        <inertia
            ixx="0.000001" ixy="0.0" ixz="0.0"
            iyy="0.000001" iyz="0.0"
            izz="0.000002"/>
      </inertial>
    </link>
    <joint name="edf${self}_right_mount" type="fixed">
      <child link="edf${self}_right"/>
      <parent link="gimbal_pitch_link${self}"/>
      <origin rpy="0 0 0" xyz="-0.15 0 0 "/>
      <axis xyz="0 0 1"/>
    </joint>
    <link name="edf${self}_right">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.00001"/>
        <inertia
            ixx="0.000001" ixy="0.0" ixz="0.0"
            iyy="0.000001" iyz="0.0"
            izz="0.000002"/>
      </inertial>
    </link>

    #### joint junction ####
    <xacro:unless value="${self == child}">
      <xacro:tiger_joint_junction_link self="${child}" child="link${child}" leg="${leg}"/>
    </xacro:unless>

    #### joints ####
    #### link joint ####
    <xacro:unless value="${self == child}">
      <joint name="joint${child}_yaw" type="revolute">
        <limit effort="100" lower="${-pi/2}" upper="${pi}" velocity="3.0"/>
        <parent link="link${self}"/>
        <child link="joint_junction_link${child}"/>
        <origin rpy="0 0 0" xyz="${general_link_length} 0 0"/>
        <axis xyz="0 0 1"/>
        <dynamics damping="0.8" friction="0.0"/>
      </joint>
    </xacro:unless>

    #### gimbal joint ####
    <joint name="gimbal${self}_roll" type="continuous">
      <limit effort="1.5" lower="${pi * -6}" upper="${pi * 6}" velocity="10.0"/>
      <parent link="link${self}"/>
      <child link="gimbal_roll_link${self}"/>
      <origin rpy="0 0 0" xyz="0.268 0.0 0.0"/>
      <axis xyz="1 0 0"/>
      <dynamics damping="0.8" friction="0.0"/>
    </joint>

    <joint name="gimbal${self}_pitch" type="continuous">
      <limit effort="1.5" lower="${pi * -6}" upper="${pi * 6}" velocity="10.0"/>
      <parent link="gimbal_roll_link${self}"/>
      <child link="gimbal_pitch_link${self}"/>
      <origin rpy="0 0 ${-pi / 2}" xyz="-0.0065 0.0 -0.027"/>
      <axis xyz="-1 0 0"/>
      <dynamics damping="0.8" friction="0.0"/>
    </joint>

    #### rotor joint (virtual) ####
    <joint name="rotor${self}" type="continuous">
     <limit effort="100.0" lower="0" upper="${max_force}" velocity="0.5"/>
      <parent link="gimbal_pitch_link${self}"/>
      <child link="thrust${self}"/>
      <origin rpy="0 0 0" xyz="0 0 0"/>
      <axis xyz="0 0 1"/>
    </joint>

    #### battery ####
    <xacro:if value="${battery == 1}">
      <xacro:extra_module name="bat${self}" parent="link${self}" visible="1"
                          model_url="package://tiger/urdf/v1/mesh/battery/ZIPPY-3000-25C-6S.dae">
        <origin xyz="0.1395 0.0 -0.018" rpy="0 ${pi} 0"/>
        <inertial>
          <mass value="0.4170000"/>
          <origin xyz="-0.0005920 0.0000000 0.0211150" rpy="0 0 0"/>
          <inertia
              ixx="0.0000994" iyy="0.0007104" izz="0.0006865"
              ixy="0.0000000" iyz="0.0000000" ixz="-0.0000042"/>
        </inertial>
      </xacro:extra_module>
    </xacro:if>

    #### leg ####
    <xacro:if value="${leg == 1}">
      <xacro:if value="${link_type == 'end'}">
        <xacro:extra_module name="end_leg${self}" parent="link${self}" visible="1" collision="1"
                            model_url="package://tiger/urdf/v1/mesh/leg/end_leg.dae">
          <origin xyz="0.4835 0.0 0.0" rpy="0 0 0"/>
          <inertial>
            <mass value="0.0547396"/>
            <origin xyz="0.0000000 -0.0000209 -0.0336847" rpy="0 0 0"/>
            <inertia
                ixx="0.0001080" iyy="0.0001062" izz="0.0000123"
                ixy="0.0000000" iyz="0.0000000" ixz="0.0000000"/>
          </inertial>
        </xacro:extra_module>
      </xacro:if>
    </xacro:if>


    #### hardware interface ####
    <xacro:unless value="${self == child}">
      <xacro:joint_transmission joint="joint${child}_yaw"/>
    </xacro:unless>

    <xacro:joint_transmission joint="gimbal${self}_roll"/>
    <xacro:joint_transmission joint="gimbal${self}_pitch"/>

    <transmission name="rotor_tran${self}">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="rotor${self}">
        <hardwareInterface>RotorInterface</hardwareInterface>
      </joint>
      <actuator name="rotor_actuator${self}">
        <hardwareInterface>RotorInterface</hardwareInterface>
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro>

</robot>
